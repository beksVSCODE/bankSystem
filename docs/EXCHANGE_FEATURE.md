# Функция обмена валют

## Обзор

Функция обмена валют позволяет пользователям конвертировать средства между счетами в разных валютах (RUB, USD, EUR) с использованием актуальных курсов обмена.

## Основные возможности

### 1. Обмен валют
- Поддерживаемые валюты: RUB (₽), USD ($), EUR (€)
- Автоматический расчет суммы обмена на основе курса
- Проверка достаточности средств
- Выбор счетов списания и зачисления

### 2. Курсы обмена

Текущие курсы обмена (mock-данные):
- USD → RUB: 92.45 ₽
- EUR → RUB: 100.82 ₽
- USD → EUR: 0.92 €
- RUB → USD: 0.0108 $
- RUB → EUR: 0.0099 €
- EUR → USD: 1.09 $

### 3. Интерфейс

#### Компоненты:
- **ExchangeModal** - модальное окно для выполнения обмена
  - Расположение: `src/components/ExchangeModal.tsx`
  - Используется на страницах Dashboard и Accounts

#### Функциональность:
- Выбор валюты отправителя и получателя
- Ввод суммы с автоматическим расчетом конвертации
- Быстрая смена валют (кнопка swap)
- Отображение текущего курса обмена
- Выбор счетов для списания и зачисления
- Проверка баланса в реальном времени

## Использование

### Открытие модального окна обмена

```tsx
import { ExchangeModal } from '@/components/ExchangeModal';

function MyComponent() {
  const [exchangeOpen, setExchangeOpen] = useState(false);

  return (
    <>
      <Button onClick={() => setExchangeOpen(true)}>
        Обмен валюты
      </Button>
      
      <ExchangeModal 
        open={exchangeOpen} 
        onClose={() => setExchangeOpen(false)} 
      />
    </>
  );
}
```

### Процесс обмена

1. Откройте модальное окно обмена
2. Выберите валюту, которую хотите отдать (FROM)
3. Выберите валюту, которую хотите получить (TO)
4. Введите сумму для обмена
5. Система автоматически рассчитает сумму получения
6. Выберите счет списания (с нужной валютой FROM)
7. Выберите счет зачисления (с нужной валютой TO)
8. Нажмите кнопку "Обменять"
9. Дождитесь подтверждения операции

## Валидация

Система проверяет:
- ✅ Заполнение всех обязательных полей
- ✅ Различие счетов списания и зачисления
- ✅ Различие валют обмена
- ✅ Достаточность средств на счете списания
- ✅ Корректность суммы обмена (больше 0)

## Store (Zustand)

### Функция exchangeCurrency

```typescript
exchangeCurrency: (
  fromAccountId: string,    // ID счета списания
  toAccountId: string,      // ID счета зачисления
  fromAmount: number,       // Сумма списания
  toAmount: number          // Сумма зачисления
) => boolean
```

#### Что делает функция:
1. Проверяет существование обоих счетов
2. Проверяет достаточность средств
3. Списывает средства со счета отправителя
4. Зачисляет средства на счет получателя
5. Создает две транзакции:
   - Расходная транзакция на счете списания
   - Приходная транзакция на счете зачисления

#### Пример использования:

```typescript
const exchangeCurrency = useFinancialStore(state => state.exchangeCurrency);

// Обмен 10,000 RUB на 108 USD
const success = exchangeCurrency(
  'acc-rub-1',     // Счет в рублях
  'acc-usd-1',     // Счет в долларах
  10000,           // 10,000 RUB
  108              // 108 USD (по курсу 92.45)
);

if (success) {
  console.log('Обмен выполнен успешно');
} else {
  console.log('Ошибка при обмене');
}
```

## Структура транзакций

После обмена создаются две транзакции:

### Транзакция списания:
```typescript
{
  date: '2026-02-10',
  description: 'Обмен RUB → USD',
  category: 'transfer',
  amount: -10000,              // Отрицательная сумма
  type: 'expense',
  accountId: 'acc-rub-1',
  status: 'completed'
}
```

### Транзакция зачисления:
```typescript
{
  date: '2026-02-10',
  description: 'Обмен RUB → USD',
  category: 'transfer',
  amount: 108,                 // Положительная сумма
  type: 'income',
  accountId: 'acc-usd-1',
  status: 'completed'
}
```

## Особенности реализации

### 1. Автоматический расчет
- При вводе суммы происходит автоматический пересчет с задержкой 300ms
- Используется debounce для оптимизации производительности

### 2. Swap функциональность
- Кнопка быстрой смены валют меняет местами FROM ↔ TO
- Автоматически пересчитывает суммы
- Сбрасывает выбранные счета

### 3. Динамическое обновление счетов
- При смене валюты автоматически фильтруются доступные счета
- Показывается только счета с нужной валютой
- Отображается текущий баланс выбранного счета

### 4. UX улучшения
- Форматирование чисел с разделителями тысяч
- Символы валют (₽, $, €)
- Загрузка при расчете
- Анимация успешной операции
- Информативные сообщения об ошибках

## Файлы проекта

```
src/
├── components/
│   └── ExchangeModal.tsx          # Компонент модального окна обмена
├── mock/
│   ├── financialStore.ts          # Store с функцией exchangeCurrency
│   └── types.ts                   # Типы данных
└── pages/
    ├── Dashboard.tsx              # Использует ExchangeModal
    └── Accounts.tsx               # Использует ExchangeModal
```

## Возможные улучшения

1. **Реальные курсы валют**
   - Интеграция с API валютных курсов
   - Автоматическое обновление курсов

2. **История курсов**
   - График изменения курса
   - Исторические данные

3. **Комиссии**
   - Добавление комиссии за обмен
   - Разные тарифы для разных типов счетов

4. **Лимиты**
   - Минимальная/максимальная сумма обмена
   - Дневные лимиты на операции

5. **Избранные валютные пары**
   - Сохранение часто используемых пар
   - Быстрый доступ к избранным

## Тестирование

Для тестирования функции обмена:

1. Убедитесь, что у вас есть счета в разных валютах
2. Откройте Dashboard или Accounts
3. Нажмите кнопку "Обмен" или "Exchange"
4. Выполните тестовый обмен
5. Проверьте обновление балансов
6. Проверьте создание транзакций

## Troubleshooting

### Проблема: "Недостаточно средств"
**Решение:** Проверьте баланс выбранного счета списания

### Проблема: "Выберите разные счета"
**Решение:** Убедитесь, что выбраны разные счета для списания и зачисления

### Проблема: "Выберите разные валюты"
**Решение:** Валюты FROM и TO должны различаться

### Проблема: Нет доступных счетов
**Решение:** Создайте счета в нужных валютах через модальное окно управления картами
